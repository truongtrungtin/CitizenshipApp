@inherits LayoutComponentBase
@implements IDisposable

<div class="page">
  <div class="sidebar">
    <NavMenu />
  </div>

  <main>
    <article class="content px-4">
      @Body
    </article>
  </main>
</div>

@code {

  protected override void OnInitialized()
  {
    // Listen to auth lifecycle: login / logout / onboarding
    AppState.OnChange += HandleAppStateChanged;
    UserSettings.OnChange += HandleUserSettingsChanged;
  }

  protected override async Task OnAfterRenderAsync(bool firstRender)
  {
    if (!firstRender)
      return;

    // First render -> apply persisted UI settings (FontScale, etc.)
    await UserSettings.EnsureLoadedAsync();
  }

  private async void HandleAppStateChanged()
  {
    // Auth state changed -> cached settings may be stale
    await UserSettings.InvalidateAsync();

    // Re-apply according to the new state
    _ = InvokeAsync(async () =>
    {
      await UserSettings.EnsureLoadedAsync();
      StateHasChanged();
    });
  }

  private void HandleUserSettingsChanged()
  {
    _ = InvokeAsync(StateHasChanged);
  }

  public void Dispose()
  {
    AppState.OnChange -= HandleAppStateChanged;
    UserSettings.OnChange -= HandleUserSettingsChanged;
  }
}
