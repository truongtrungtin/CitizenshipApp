@implements IDisposable

@inject NavigationManager Nav
@inject AppState State

@if (!_isReady)
{
  <div class="p-4">Loading...</div>
}
else
{
  @ChildContent
}

@code {
  [Parameter] public RenderFragment? ChildContent { get; set; }

  private bool _isReady;

  protected override async Task OnInitializedAsync()
  {
    // Ensure state is loaded exactly once when app starts
    await State.InitializeAsync();

    // Re-check guard when navigation occurs
    Nav.LocationChanged += OnLocationChanged;

    _isReady = true;

    // First guard pass
    GuardCurrentRoute();
  }

  private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
  {
    GuardCurrentRoute();
    StateHasChanged();
  }

  private void GuardCurrentRoute()
  {
    var relativePath = Nav.ToBaseRelativePath(Nav.Uri);
    var path = "/" + relativePath.TrimStart('/');

    // Public pages (allowed without auth)
    if (IsPublicPath(path))
      return;

    if (!State.IsAuthenticated)
    {
      Nav.NavigateTo("/login", replace: true);
      return;
    }

    // Onboarding gate: only allow onboarding page until completed
    if (!State.IsOnboarded && !path.StartsWith("/onboarding", StringComparison.OrdinalIgnoreCase))
    {
      Nav.NavigateTo("/onboarding", replace: true);
    }
  }

  private static bool IsPublicPath(string path)
  {
    // Normalize "/" edge cases
    if (string.IsNullOrWhiteSpace(path) || path == "/")
      return true;

    // Auth/public screens
    return path.StartsWith("/login", StringComparison.OrdinalIgnoreCase)
           || path.StartsWith("/register", StringComparison.OrdinalIgnoreCase);
  }

  public void Dispose()
  {
    Nav.LocationChanged -= OnLocationChanged;
  }
}
