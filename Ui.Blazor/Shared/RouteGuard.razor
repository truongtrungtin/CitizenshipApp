@implements IDisposable
@using Microsoft.AspNetCore.Components.Routing

<Router AppAssembly="@typeof(Program).Assembly">
  <Found Context="routeData">
    <RouteView RouteData="@routeData" DefaultLayout="@typeof(MainLayout)" />
  </Found>
  <NotFound>
    <LayoutView Layout="@typeof(MainLayout)">
      <p>Page not found.</p>
    </LayoutView>
  </NotFound>
</Router>

@code {
  // Public pages that do not require authentication.
  // IMPORTANT: "/" is no longer public because Index.razor handles redirect.
  private static readonly HashSet<string> PublicPaths = new(StringComparer.OrdinalIgnoreCase)
{
"/login",
"/register"
};

  // Paths allowed even if user is authenticated but NOT onboarded.
  private static readonly HashSet<string> AllowedWhenNotOnboarded = new(StringComparer.OrdinalIgnoreCase)
{
"/onboarding",
"/logout"
};

  protected override void OnInitialized()
  {
    // Re-run guard logic on every navigation.
    Nav.LocationChanged += OnLocationChanged;
  }

  private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
  {
    ApplyGuards();
  }

  protected override void OnAfterRender(bool firstRender)
  {
    if (firstRender)
    {
      ApplyGuards();
    }
  }

  private void ApplyGuards()
  {
    if (!AppState.IsInitialized)
      return;

    var path = "/" + Nav.ToBaseRelativePath(Nav.Uri);
    path = path.Split('?', '#')[0]; // normalize

    // 1) Not authenticated: only allow public routes
    if (!AppState.IsAuthenticated)
    {
      if (!PublicPaths.Contains(path) && path != "/")
      {
        Nav.NavigateTo("/login", replace: true);
      }
      return;
    }

    // 2) Authenticated but NOT onboarded: force onboarding
    if (!AppState.IsOnboarded)
    {
      if (!AllowedWhenNotOnboarded.Contains(path))
      {
        Nav.NavigateTo("/onboarding", replace: true);
      }
      return;
    }

    // 3) Authenticated and onboarded: do not allow going back to login/register
    if (PublicPaths.Contains(path))
    {
      Nav.NavigateTo("/home", replace: true);
    }
  }

  public void Dispose()
  {
    Nav.LocationChanged -= OnLocationChanged;
  }
}