@page "/settings"
<h1>@T["Settings.Title"]</h1>

@if (!AppState.IsAuthenticated)
{
  <div class="alert alert-warning">@T["Settings.LoginRequired"]</div>
  <button class="btn btn-primary" @onclick="GoLogin">@T["Settings.GoLogin"]</button>
}
else if (_loading)
{
  <p>@T["Settings.Loading"]</p>
}
else
{
  @if (!string.IsNullOrWhiteSpace(_message))
  {
    <div class="alert alert-info mt-3">@_message</div>
  }

  @if (!string.IsNullOrWhiteSpace(_error))
  {
    <div class="alert alert-danger mt-3">@_error</div>
  }

  <div class="mb-3">
    <label class="form-label fw-semibold">@T["Settings.Language"]</label>
    <select class="form-select" @bind="_edit.Language" disabled="@_saving">
      <option value="@LanguageCode.Vi">@T["Lang.Vi"]</option>
      <option value="@LanguageCode.En">@T["Lang.En"]</option>
    </select>

    @if (GetFieldError("Language") is { } langErr)
    {
      <div class="text-danger small mt-1">@langErr</div>
    }
  </div>

  <div class="mb-3">
    <label class="form-label fw-semibold">@T["Settings.SystemLanguage"]</label>
    <select class="form-select" @bind="_edit.SystemLanguage" @bind:after="OnSystemLanguageChanged"
      disabled="@_saving">
      <option value="@LanguageCode.Vi">@T["Lang.Vi"]</option>
      <option value="@LanguageCode.En">@T["Lang.En"]</option>
    </select>

    @if (GetFieldError("SystemLanguage") is { } sysLangErr)
    {
      <div class="text-danger small mt-1">@sysLangErr</div>
    }
  </div>

  <div class="mb-3">
    <label class="form-label fw-semibold">@T["Settings.Font"]</label>
    <select class="form-select" value="@_edit.FontScale" @onchange="OnFontScaleChanged" disabled="@_saving">
      <option value="@FontScale.Medium">@T["Font.Small"]</option>
      <option value="@FontScale.Large">@T["Font.Medium"]</option>
      <option value="@FontScale.XLarge">@T["Font.Large"]</option>
    </select>

    @if (GetFieldError("FontScale") is { } fontErr)
    {
      <div class="text-danger small mt-1">@fontErr</div>
    }
  </div>

  <div class="mb-3">
    <label class="form-label fw-semibold">@T["Settings.Audio"]</label>
    <select class="form-select" @bind="_edit.AudioSpeed" disabled="@_saving">
      <option value="@AudioSpeed.Slow">@T["Audio.Slow"]</option>
      <option value="@AudioSpeed.Normal">@T["Audio.Medium"]</option>
      <option value="@AudioSpeed.Fast">@T["Audio.Fast"]</option>
    </select>

    @if (GetFieldError("AudioSpeed") is { } audioErr)
    {
      <div class="text-danger small mt-1">@audioErr</div>
    }
  </div>

  <div class="mb-3">
    <label class="form-label fw-semibold">@T["Settings.DailyGoal"]</label>
    <input class="form-control" type="number" @bind="_edit.DailyGoalMinutes" min="1" max="200" disabled="@_saving" />

    @if (GetFieldError("DailyGoalMinutes") is { } goalErr)
    {
      <div class="text-danger small mt-1">@goalErr</div>
    }
  </div>

  <div class="mb-3">
    <label class="form-label fw-semibold">@T["Settings.Focus"]</label>
    <select class="form-select" @bind="_edit.Focus" disabled="@_saving">
      <option value="@StudyFocus.Civics">@T["Focus.Civics"]</option>
      <option value="@StudyFocus.Reading">@T["Focus.Reading"]</option>
      <option value="@StudyFocus.Writing">@T["Focus.Writing"]</option>
    </select>

    @if (GetFieldError("Focus") is { } focusErr)
    {
      <div class="text-danger small mt-1">@focusErr</div>
    }
  </div>

  <div class="form-check mb-4">
    <input class="form-check-input" type="checkbox" id="silentMode" checked="@_edit.SilentMode"
      @onchange="OnSilentChanged" disabled="@_saving" />
    <label class="form-check-label" for="silentMode">@T["Settings.Silent"]</label>

    @if (GetFieldError("SilentMode") is { } silentErr)
    {
      <div class="text-danger small mt-1">@silentErr</div>
    }
  </div>

  <button class="btn btn-primary" @onclick="SaveAsync" disabled="@_saving">@T["Settings.Save"]</button>
}

@code {
  private bool _loading = true;
  private bool _saving;

  private string? _message;
  private string? _error;

  private Dictionary<string, string[]> _fieldErrors = new(StringComparer.OrdinalIgnoreCase);

  // Full settings edit model
  private UserSettingContracts _edit = new(); // uses defaults

  private async Task OnFontScaleChanged(ChangeEventArgs e)
  {
    if (e.Value is null)
      return;

    // Option value = enum name ("Medium","Large","XLarge")
    if (!Enum.TryParse<FontScale>(e.Value.ToString(), out var scale))
      return;

    _edit = _edit with { FontScale = scale };

    // Preview immediately across the whole app
    await UserSettings.ApplyAsync(_edit);
  }

  private async Task OnSystemLanguageChanged()
  {
    // Preview UI language immediately without saving
    await UserSettings.PreviewAsync(_edit);
  }

  private string? GetFieldError(string field)
  {
    return _fieldErrors.TryGetValue(field, out var msgs) && msgs.Length > 0
    ? string.Join(" ", msgs)
    : null;
  }

  private void ClearErrors()
  {
    _error = null;
    _fieldErrors.Clear();
  }

  protected override async Task OnInitializedAsync()
  {
    if (!AppState.IsAuthenticated)
    {
      _loading = false;
      return;
    }

    try
    {
      ClearErrors();
      _message = null;

      _edit = await Api.GetMeSettingsFullAsync();

      // Ensure SystemLanguage is set for older accounts
      if (_edit.SystemLanguage == default)
      {
        _edit = _edit with { SystemLanguage = LanguageCode.Vi };
      }

      await UserSettings.ApplyFromServerAsync(_edit);


    }
    catch (ApiException ex)
    {
      _error = ex.Detail ?? ex.Title ?? ex.Message;
      _fieldErrors = new Dictionary<string, string[]>(ex.Errors, StringComparer.OrdinalIgnoreCase);
    }
    catch (Exception ex)
    {
      _error = ex.Message;
    }
    finally
    {
      _loading = false;
    }
  }

  private void OnSilentChanged(ChangeEventArgs e)
  {
    bool value =
    e.Value is bool b ? b
    : bool.TryParse(e.Value?.ToString(), out var parsed) && parsed;

    _edit = _edit with { SilentMode = value };
  }

  private async Task SaveAsync()
  {
    _message = null;
    ClearErrors();
    _saving = true;

    try
    {
      await Api.UpdateMeSettingsFullAsync(_edit);
      await UserSettings.ReloadAsync();
      await UserSettings.ApplyFromServerAsync(_edit);
      _message = T["Settings.Saved"];
    }
    catch (ApiException ex)
    {
      _error = ex.Detail ?? ex.Title ?? ex.Message;
      _fieldErrors = new Dictionary<string, string[]>(ex.Errors, StringComparer.OrdinalIgnoreCase);
    }
    catch (Exception ex)
    {
      _error = ex.Message;
    }
    finally
    {
      _saving = false;
    }
  }

  private void GoLogin() => Nav.NavigateTo("/login");
}
