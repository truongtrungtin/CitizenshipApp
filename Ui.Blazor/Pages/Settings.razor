@page "/settings"

<h1>Settings</h1>

@if (!AppState.IsAuthenticated)
{
  <div class="alert alert-warning">Please login to access settings.</div>
  <button class="btn btn-primary" @onclick="GoLogin">Go to login</button>
}
else if (_loading)
{
  <p>Loading settings...</p>
}
else
{
  <div class="mb-3">
    <label class="form-label">Language</label>

    <!-- Bind trực tiếp vào _edit.Language (enum) -->
    <select class="form-select" @bind="_edit.Language">
      <option value="@LanguageCode.Vi">Vietnamese</option>
      <option value="@LanguageCode.En">English</option>
    </select>
  </div>

  <div class="mb-3">
    <label class="form-label">Daily study goal</label>

    <!-- Bind trực tiếp vào _edit.DailyGoalMinutes -->
    <input class="form-control" type="number" @bind="_edit.DailyGoalMinutes" min="1" max="200"/>
  </div>

  <button class="btn btn-primary" @onclick="SaveAsync" disabled="@_saving">Save</button>

  @if (!string.IsNullOrWhiteSpace(_message))
  {
    <div class="alert alert-info mt-3">@_message</div>
  }
}

@code {
  private MeSettingsResponse? _current;
  private UpdateMeSettingsRequest _edit = new();

  private bool _loading = true;
  private bool _saving;
  private string? _message;

  protected override async Task OnInitializedAsync()
  {
    try
    {
      _current = await Api.GetMeSettingsAsync();

      _edit = new UpdateMeSettingsRequest
      {
        Language = _current.Language,
        DailyGoalMinutes = _current.DailyGoalMinutes
      };
    }
    catch (Exception ex)
    {
      _message = ex.Message;
    }
    finally
    {
      _loading = false;
    }
  }

  private async Task SaveAsync()
  {
    _message = null;
    _saving = true;

    try
    {
      await Api.UpdateMeSettingsAsync(_edit);

      // (Optional) update state nếu bạn có lưu settings trong AppState
      // State.MeSettings = new MeSettingsResponse { Language = _edit.Language, DailyGoalMinutes = _edit.DailyGoalMinutes };

      _message = "Saved.";
    }
    catch (Exception ex)
    {
      _message = ex.Message;
    }
    finally
    {
      _saving = false;
    }
  }

  private void GoLogin()
  {
    Nav.NavigateTo("/login");
  }

}
