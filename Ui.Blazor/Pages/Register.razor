@page "/register"
<h1>@T["Auth.Register.Title"]</h1>

@if (!string.IsNullOrWhiteSpace(Error))
{
  <div class="alert alert-danger mt-3">@Error</div>
}

<div class="mb-3">
  <label class="form-label">@T["Auth.Username.Label"]</label>
  <input class="form-control" @bind="Username" disabled="@Busy" />
  @if (GetFieldError("Email") is { } emailErr)
  {
    <div class="text-danger small mt-1">@emailErr</div>
  }
</div>

<div class="mb-3">
  <label class="form-label">@T["Auth.Password.Label"]</label>
  <input class="form-control" type="password" @bind="Password" disabled="@Busy" />
  @if (GetFieldError("Password") is { } passErr)
  {
    <div class="text-danger small mt-1">@passErr</div>
  }
</div>

<button class="btn btn-primary" @onclick="OnRegister" disabled="@Busy">@T["Auth.Register.Button"]</button>
<button class="btn btn-link" @onclick="GoLogin" disabled="@Busy">@T["Auth.GoLogin"]</button>

@code {
  private string Username { get; set; } = "";
  private string Password { get; set; } = "";

  // General error
  private string? Error { get; set; }

  // Field-level errors
  private Dictionary<string, string[]> FieldErrors { get; set; }
  = new(StringComparer.OrdinalIgnoreCase);

  private bool Busy { get; set; }

  private string? GetFieldError(string field)
  {
    return FieldErrors.TryGetValue(field, out var msgs) && msgs.Length > 0
    ? string.Join(" ", msgs)
    : null;
  }

  private void ClearErrors()
  {
    Error = null;
    FieldErrors.Clear();
  }

  private async Task OnRegister()
  {
    ClearErrors();
    Busy = true;

    try
    {
      var req = new RegisterRequest { Email = Username, Password = Password };
      var auth = await Api.RegisterAsync(req);

      await AppState.SetAuthAsync(
      auth.AccessToken,
      userId: auth.UserId.ToString(),
      isOnboarded: auth.IsOnboarded
      );

      Nav.NavigateTo(auth.IsOnboarded ? "/home" : "/onboarding", replace: true);

    }
    catch (ApiException ex)
    {
      Error = ex.Detail ?? ex.Title ?? ex.Message;
      FieldErrors = new Dictionary<string, string[]>(ex.Errors, StringComparer.OrdinalIgnoreCase);
    }
    catch (Exception ex)
    {
      Error = ex.Message;
    }
    finally
    {
      Busy = false;
    }
  }

  private void GoLogin() => Nav.NavigateTo("/login");
}
