@page "/study"
@implements IDisposable
@inject StorageInterop Storage
@inject UiText T
@inject AuthenticationStateProvider AuthStateProvider
@inject TtsService Tts

<div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
  <h3 class="mb-0" data-testid="study-title">@T["Study.Title"]</h3>

  <div class="btn-group" role="group" aria-label="@T["Study.Language"]">
    <button type="button" class="btn btn-sm @(_language == LanguageCode.Vi ? "btn-primary" : "btn-outline-primary")"
      @onclick="() => SetLanguage(LanguageCode.Vi)">
      VI
    </button>

    <button type="button" class="btn btn-sm @(_language == LanguageCode.En ? "btn-primary" : "btn-outline-primary")"
      @onclick="() => SetLanguage(LanguageCode.En)">
      EN
    </button>
  </div>
</div>

<hr />

@if (!string.IsNullOrWhiteSpace(_generalError))
{
  <div class="alert alert-danger" role="alert" data-testid="study-error">
    <strong>@T["Study.Error"]:</strong> @_generalError
  </div>
}


<div class="d-flex align-items-center gap-2 flex-wrap">
  <label class="form-label mb-0"><strong>@T["Study.Deck"]</strong></label>
  @if (UserSettings.Current is not null)
  {
    var suggestedDeck = GetSuggestedDeck();

    <span class="text-muted small">
      @T["Study.Suggested"]: <strong>@UserSettings.Current.Focus</strong>
      ‚Ä¢ @T["Study.SuggestedDeck"]:
      @if (suggestedDeck is not null)
      {
        <strong>@suggestedDeck.Name</strong>
        @($"({suggestedDeck.Code})")
      }
      else
      {
          <strong>@T["Study.None"]</strong>
      }
    </span>
  }

  <select class="form-select form-select-sm" data-testid="study-deck-select" style="min-width: 260px" value="@_selectedDeckId" @onchange="OnDeckChanged"
    disabled="@(_busy || _decks.Count == 0)">
    @if (_decks.Count == 0)
    {
      <option selected>@T["Study.NoDecks"]</option>
    }
    else
    {
      @foreach (var deck in _decks)
      {
        <option value="@deck.Id">
          @deck.Name (@deck.Code) ‚Ä¢ @deck.QuestionCount
        </option>
      }
    }
  </select>

  @if (GetFieldError("DeckId") is { } deckErr)
  {
    <div class="text-danger small mt-1">@deckErr</div>
  }

  @if (_isPrivileged)
  {
    <button class="btn btn-sm btn-outline-secondary" @onclick="ReloadAllAsync" disabled="@_busy">
      @T["Study.Reload"]
    </button>

    <button class="btn btn-sm btn-primary" @onclick="LoadNextQuestionAsync"
      disabled="@(!_selectedDeckId.HasValue || _busy)">
      @T["Study.Next"]
    </button>
  }
</div>

@if (_today is not null)
{
  <div class="mt-3 p-3 border rounded">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
      <div>
        <div class="fw-semibold">@T["Study.Today"]</div>
        <div class="text-muted small" data-testid="study-progress">
          @T["Study.Goal"]: <span data-testid="study-progress-goal">@_today.DailyGoalMinutes</span>
          &nbsp;|&nbsp; @T["Study.Answered"]: <span data-testid="study-progress-answered">@_today.TotalAnswered</span>
          &nbsp;|&nbsp; @T["Study.Correct"]: <span data-testid="study-progress-correct">@_today.CorrectAnswered</span>
        </div>
      </div>

      <div class="small text-muted">@T["Study.UtcNote"]</div>
    </div>
  </div>
}

@if (_busy && _question is null)
{
  <div class="mt-3 alert alert-info">@T["Study.Loading"]</div>
}

@if (_question is not null)
{
  <div class="mt-4 p-3 border rounded">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
      <div>
        <div class="text-muted small">@T["Study.QuestionType"]: @GetQuestionTypeLabel(_question.Type)</div>
        <div class="fs-5 fw-semibold" data-testid="study-question">@GetPrompt(_question.Prompt)</div>

        @if (_language == LanguageCode.Vi && !string.IsNullOrWhiteSpace(_question.Prompt.ViPhonetic))
        {
          <div class="mt-1 text-muted"><em>@_question.Prompt.ViPhonetic</em></div>
        }
      </div>

      <div class="d-flex align-items-center gap-2">
        @if (!IsSilentMode && _language == LanguageCode.En)
        {
          <div class="position-relative">
            <button class="btn btn-outline-primary" title="@T["Study.Listen"]" @onclick="SpeakPromptAsync"
              disabled="@(!_ttsSupported)">
              üîä
            </button>

            @if (_isSpeaking && _speakingTarget == "prompt")
            {
              <button class="btn btn-outline-secondary position-absolute top-0 start-0" title="@T["Study.Stop"]"
                style="transform: translate(0, 0);" @onclick="StopSpeakingAsync" disabled="@(!_ttsSupported)">
                ‚èπÔ∏è
              </button>
            }
          </div>
        }
        else if (_language == LanguageCode.En)
        {
          <span class="text-muted small">@T["Study.SilentModeHint"]</span>
        }

        @if (_isPrivileged)
        {
          <div class="text-muted small">ID: @_question.Id</div>
        }
      </div>
    </div>

    @if (_lastAnswer is not null)
    {
      <hr />
      <div class="d-flex align-items-center gap-2 flex-wrap">
        <span class="badge @(_lastAnswer.IsCorrect ? "bg-success" : "bg-danger")" data-testid="study-result-badge">
          @(_lastAnswer.IsCorrect ? T["Study.CorrectBadge"] : T["Study.IncorrectBadge"])
        </span>

        <div class="small"><strong>@T["Study.YourAnswer"]:</strong> @GetOptionLabel(_lastAnswer.SelectedKey)</div>
        <div class="small"><strong>@T["Study.CorrectAnswer"]:</strong> @GetOptionLabel(_lastAnswer.CorrectKey)</div>
      </div>

      @if (!string.IsNullOrWhiteSpace(GetExplain(_question.Prompt)))
      {
        <div class="mt-3 alert alert-secondary mb-0">
          <div class="fw-semibold">@T["Study.Explanation"]</div>
          <div>@GetExplain(_question.Prompt)</div>
        </div>
      }

      <div class="mt-3 d-flex gap-2">
        <button class="btn btn-primary" data-testid="study-continue" @onclick="LoadNextQuestionAsync" disabled="@_busy">@T["Study.Continue"]</button>
        <button class="btn btn-outline-secondary" @onclick="ClearAnswer">@T["Study.ClearResult"]</button>
      </div>
    }
    else
    {
      <hr />

      @* Field errors close to the answer interaction *@
      @if (GetFieldError("SelectedKey") is { } selectedErr)
      {
        <div class="text-danger small mb-2">@selectedErr</div>
      }
      @if (GetFieldError("QuestionId") is { } questionErr)
      {
        <div class="text-danger small mb-2">@questionErr</div>
      }

      @if (_question.Options.Count == 0)
      {
        <div class="alert alert-warning mb-0">
          @T["Study.NoOptions"]
        </div>
      }
      else
      {
        <div class="d-grid gap-2">
          @foreach (var opt in _question.Options)
          {
            <div class="d-flex align-items-center gap-2">
              <button class="btn btn-outline-primary text-start flex-grow-1" data-testid="study-answer-@opt.Key" disabled="@_busy"
                @onclick="() => SubmitAnswerAsync(opt.Key)">
                <strong>@opt.Key</strong>. @GetOptionText(opt)
              </button>

              @if (!IsSilentMode && _ttsSupported && _language == LanguageCode.En)
              {
                <div class="position-relative">
                  <button class="btn btn-outline-secondary" title="@T["Study.Listen"]"
                    @onclick="() => SpeakOptionAsync(opt)">
                    üîä
                  </button>

                  @if (_isSpeaking && _speakingTarget == opt.Key)
                  {
                    <button class="btn btn-outline-secondary position-absolute top-0 start-0" title="@T["Study.Stop"]"
                      style="transform: translate(0, 0);" @onclick="StopSpeakingAsync" disabled="@(!_ttsSupported)">
                      ‚èπÔ∏è
                    </button>
                  }
                </div>
              }
            </div>
          }
        </div>
      }
    }
  </div>

@if (_question is not null && _language == LanguageCode.En)
{
  <div class="mt-3 small text-muted">
    <button class="btn btn-link btn-sm p-0" @onclick="ToggleSessionSilentAsync">
      @T["Study.SessionSilentHint"]
    </button>
  </div>
}
}

@code {
  private readonly List<DeckListItem> _decks = new();
  private Guid? _selectedDeckId;

  private TodayProgressResponse? _today;
  private Question? _question;

  private AnswerResult? _lastAnswer;
  private bool _busy;

  /// <summary>
  /// General (non-field) error shown as a top alert.
  /// This is used for business errors (401/403/404/etc.) or unexpected failures.
  /// </summary>
  private string? _generalError;
  private Guid? _suggestedDeckId;

  /// <summary>
  /// Field-level validation errors returned by API (ValidationProblemDetails).
  /// Example keys: "DeckId", "QuestionId", "SelectedKey".
  /// </summary>
  private Dictionary<string, string[]> _fieldErrors = new(StringComparer.OrdinalIgnoreCase);

  private LanguageCode _language = LanguageCode.En;
  private bool IsVietnamese => _language == LanguageCode.Vi;
  private bool _isPrivileged;
  private bool _ttsSupported;
  private bool _isSpeaking;
  private string? _speakingTarget;
  private bool _sessionSilentMode;
  private bool IsSilentMode => UserSettings.Current?.SilentMode == true || _sessionSilentMode;
  private DotNetObjectReference<Study>? _ttsRef;

  private string SelectedDeckIdKey =>
  string.IsNullOrWhiteSpace(AppState.UserId)
  ? "study.selectedDeckId:anonymous"
  : $"study.selectedDeckId:{AppState.UserId}";
  protected override async Task OnInitializedAsync()
  {
    _ttsRef = DotNetObjectReference.Create(this);
    _ttsSupported = await Tts.IsSupportedAsync();
    await LoadPrivilegesAsync();
    await ReloadAllAsync();
  }

  private async Task LoadPrivilegesAsync()
  {
    var authState = await AuthStateProvider.GetAuthenticationStateAsync();
    var user = authState.User;
    _isPrivileged = user.IsInRole("Admin") || user.IsInRole("Dev");
  }

  private void SetLanguage(LanguageCode lang)
  {
    _language = lang;
    StateHasChanged();
  }

  private string? GetFieldError(string field)
  {
    return _fieldErrors.TryGetValue(field, out var msgs) && msgs.Length > 0
    ? string.Join(" ", msgs)
    : null;
  }

  private void ClearErrors()
  {
    _generalError = null;
    _fieldErrors.Clear();
  }

  private async Task ReloadAllAsync()
  {
    ClearErrors();
    _busy = true;

    await StopSpeakingAsync();

    try
    {
      // Load full settings once from client-side state.
      // Settings are loaded from the full endpoint (/api/me/settings/full) via UserSettingsState.
      await UserSettings.EnsureLoadedAsync();

      var settings = UserSettings.Current;
      if (settings is not null)
      {
        // Apply language from full settings.
        SetLanguage(settings.Language);
      }
      // else: keep default (_language = En)

      _decks.Clear();
      _decks.AddRange(await Api.GetDecksAsync());


      // Always compute suggestion for debug UI (even if we don't use it to select).
      _suggestedDeckId = settings is not null ? SuggestDeckId(settings.Focus) : null;

      // Load last selected deck from localStorage (if any).
      Guid? storedDeckId = null;

      try
      {
        var rawStored = await Storage.GetItemAsync(SelectedDeckIdKey);
        if (Guid.TryParse(rawStored, out var parsed))
          storedDeckId = parsed;
      }
      catch
      {
        // Ignore storage errors; we can still fallback to focus/first deck.
      }

      // Choose deck by priority:
      // 1) Current selection (if still exists)
      // 2) Stored selection (last selected by user)
      // 3) Focus suggestion
      // 4) First deck
      if (_decks.Count == 0)
      {
        _selectedDeckId = null;
      }
      else
      {
        var selectedStillValid =
        _selectedDeckId.HasValue && _decks.Any(d => d.Id == _selectedDeckId.Value);

        if (!selectedStillValid)
        {
          var storedStillValid =
          storedDeckId.HasValue && _decks.Any(d => d.Id == storedDeckId.Value);

          if (storedStillValid)
          {
            _selectedDeckId = storedDeckId;
          }
          else
          {
            Guid? suggested = null;

            if (settings is not null)
              suggested = SuggestDeckId(settings.Focus);

            _selectedDeckId = suggested ?? _decks[0].Id;
          }
        }
      }
      await LoadTodayAsync();
      await LoadNextQuestionAsync();
    }
    catch (ApiException ex)
    {
      _generalError = ex.Detail ?? ex.Title ?? ex.Message;
      _fieldErrors = new Dictionary<string, string[]>(ex.Errors, StringComparer.OrdinalIgnoreCase);
    }
    catch (Exception ex)
    {
      _generalError = ex.Message;
    }
    finally
    {
      _busy = false;
    }
  }

  /// <summary>
  /// Suggest a deck based on user's Focus.
  /// MVP heuristic:
  /// - Match deck.Code or deck.Name containing keywords: "civics", "reading", "writing".
  /// - If no match, return null (caller will fallback to first deck).
  /// </summary>
  private Guid? SuggestDeckId(StudyFocus focus)
  {
    if (_decks.Count == 0)
      return null;

    // Map Focus -> keyword used for matching deck Code/Name
    var keyword = focus switch
    {
      StudyFocus.Civics => "civics",
      StudyFocus.Reading => "reading",
      StudyFocus.Writing => "writing",
      _ => null
    };

    if (string.IsNullOrWhiteSpace(keyword))
      return null;

    var hit = _decks.FirstOrDefault(d =>
    (!string.IsNullOrWhiteSpace(d.Code) && d.Code.Contains(keyword, StringComparison.OrdinalIgnoreCase)) ||
    (!string.IsNullOrWhiteSpace(d.Name) && d.Name.Contains(keyword, StringComparison.OrdinalIgnoreCase))
    );

    return hit?.Id;
  }

  private async Task OnDeckChanged(ChangeEventArgs e)
  {
    ClearErrors();

    await StopSpeakingAsync();

    var raw = e.Value?.ToString();
    if (!Guid.TryParse(raw, out var deckId))
      return;

    _selectedDeckId = deckId;
    // Persist user's selection for next visits.
    try
    {
      await Storage.SetItemAsync(SelectedDeckIdKey, deckId.ToString());
    }
    catch
    {
      // Ignore storage failures.
    }
    _lastAnswer = null;

    await LoadNextQuestionAsync();
  }

  private async Task LoadTodayAsync()
  {
    try
    {
      _today = await Api.GetTodayProgressAsync();
    }
    catch
    {
      // Today progress is optional UI; ignore errors here to avoid blocking study.
      _today = null;
    }
  }

  private async Task LoadNextQuestionAsync()
  {
    ClearErrors();
    _lastAnswer = null;

    await StopSpeakingAsync();

    if (!_selectedDeckId.HasValue)
      return;

    _busy = true;

    try
    {
      var res = await Api.GetNextQuestionAsync(_selectedDeckId.Value);
      _question = res.Question;

      if (_ttsSupported && !IsSilentMode && _language == LanguageCode.En)
      {
        await SpeakPromptAsync();
      }
    }
    catch (ApiException ex)
    {
      _question = null;
      _generalError = ex.Detail ?? ex.Title ?? ex.Message;
      _fieldErrors = new Dictionary<string, string[]>(ex.Errors, StringComparer.OrdinalIgnoreCase);
    }
    catch (Exception ex)
    {
      _question = null;
      _generalError = ex.Message;
    }
    finally
    {
      _busy = false;
    }
  }

  private async Task SubmitAnswerAsync(string selectedKey)
  {
    if (!_selectedDeckId.HasValue || _question is null)
      return;

    ClearErrors();
    _busy = true;

    try
    {
      var req = new SubmitAnswerRequest
      {
        DeckId = _selectedDeckId.Value,
        QuestionId = _question.Id,
        SelectedKey = selectedKey
      };

      var res = await Api.SubmitAnswerAsync(req);

      _lastAnswer = new AnswerResult(
      selectedKey,
      res.CorrectKey ?? string.Empty,
      res.IsCorrect
      );

      await LoadTodayAsync();
    }
    catch (ApiException ex)
    {
      _generalError = ex.Detail ?? ex.Title ?? ex.Message;
      _fieldErrors = new Dictionary<string, string[]>(ex.Errors, StringComparer.OrdinalIgnoreCase);
    }
    catch (Exception ex)
    {
      _generalError = ex.Message;
    }
    finally
    {
      _busy = false;
    }
  }

  private void ClearAnswer() => _lastAnswer = null;

  private async Task SpeakPromptAsync()
  {
    if (_question is null)
      return;

    var settings = UserSettings.Current;
    var speed = settings?.AudioSpeed ?? AudioSpeed.Normal;
    var voice = settings?.Voice;
    string text = GetPrompt(_question.Prompt);

    _isSpeaking = true;
    _speakingTarget = "prompt";
    await Tts.SpeakAsync(text, _language, speed, _ttsRef!, voice);
  }

  private async Task SpeakOptionAsync(AnswerOption option)
  {
    var settings = UserSettings.Current;
    var speed = settings?.AudioSpeed ?? AudioSpeed.Normal;
    var voice = settings?.Voice;
    string text = GetOptionText(option);

    _isSpeaking = true;
    _speakingTarget = option.Key;
    await Tts.SpeakAsync(text, _language, speed, _ttsRef!, voice);
  }

  private Task StopSpeakingAsync()
  {
    _isSpeaking = false;
    _speakingTarget = null;
    return _ttsSupported ? Tts.CancelAsync().AsTask() : Task.CompletedTask;
  }

  private async Task ToggleSessionSilentAsync()
  {
    _sessionSilentMode = !_sessionSilentMode;

    if (_sessionSilentMode)
    {
      await StopSpeakingAsync();
    }
  }

  [JSInvokable]
  public void OnSpeakEnded()
  {
    _isSpeaking = false;
    _speakingTarget = null;
    _ = InvokeAsync(StateHasChanged);
  }

  public void Dispose()
  {
    _ttsRef?.Dispose();
  }

  private string GetPrompt(QuestionText t) =>
  IsVietnamese
    ? (string.IsNullOrWhiteSpace(t.TextVi) ? t.TextEn : t.TextVi)
    : t.TextEn;

  private string GetExplain(QuestionText t) =>
  IsVietnamese ? (t.ExplainVi ?? t.ExplainEn ?? "") : (t.ExplainEn ?? t.ExplainVi ?? "");

  private string GetOptionText(AnswerOption o) =>
  IsVietnamese
    ? (string.IsNullOrWhiteSpace(o.TextVi) ? o.TextEn : o.TextVi)
    : o.TextEn;

  private string GetOptionLabel(string key)
  {
    if (_question?.Options is null) return key;

    var opt = _question.Options.FirstOrDefault(o =>
    string.Equals(o.Key, key, StringComparison.OrdinalIgnoreCase));

    return opt is null ? key : $"{opt.Key}. {GetOptionText(opt)}";
  }

  private string GetQuestionTypeLabel(QuestionType type)
  {
    return type switch
    {
      QuestionType.SingleChoice => T["Study.QuestionType.SingleChoice"],
      QuestionType.MultiChoice => T["Study.QuestionType.MultiChoice"],
      QuestionType.Text => T["Study.QuestionType.Text"],
      _ => T["Study.QuestionType.Unknown"]
    };
  }

  private sealed record AnswerResult(string SelectedKey, string CorrectKey, bool IsCorrect);

  private DeckListItem? GetSuggestedDeck()
  {
    if (!_suggestedDeckId.HasValue) return null;
    return _decks.FirstOrDefault(d => d.Id == _suggestedDeckId.Value);
  }
}
