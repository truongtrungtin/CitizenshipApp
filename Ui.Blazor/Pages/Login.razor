@page "/login"
<h1>@T["Auth.Login.Title"]</h1>

@if (!string.IsNullOrWhiteSpace(Error))
{
  <div class="alert alert-danger mt-3">@Error</div>
}

<div class="mb-3">
  <label class="form-label">@T["Auth.Username.Label"]</label>
  <input class="form-control" @bind="Username" disabled="@Busy" />
  @if (GetFieldError("Email") is { } emailErr)
  {
    <div class="text-danger small mt-1">@emailErr</div>
  }
</div>

<div class="mb-3">
  <label class="form-label">@T["Auth.Password.Label"]</label>
  <input class="form-control" type="password" @bind="Password" disabled="@Busy" />
  @if (GetFieldError("Password") is { } passErr)
  {
    <div class="text-danger small mt-1">@passErr</div>
  }
</div>

<button class="btn btn-primary" @onclick="OnLogin" disabled="@Busy">@T["Auth.Login.Button"]</button>
<button class="btn btn-link" @onclick="GoRegister" disabled="@Busy">@T["Auth.GoRegister"]</button>

@code {
  private string Username { get; set; } = "";
  private string Password { get; set; } = "";

  /// <summary>
  /// General (non-field) error message displayed at top.
  /// </summary>
  private string? Error { get; set; }

  /// <summary>
  /// Field-level validation errors returned from API (ValidationProblemDetails).
  /// Keys are case-insensitive (Email, Password, DailyGoalMinutes, etc.).
  /// </summary>
  private Dictionary<string, string[]> FieldErrors { get; set; }
  = new(StringComparer.OrdinalIgnoreCase);

  private bool Busy { get; set; }

  /// <summary>
  /// Returns a combined error string for a given field name (e.g. "Email", "Password").
  /// </summary>
  private string? GetFieldError(string field)
  {
    return FieldErrors.TryGetValue(field, out var msgs) && msgs.Length > 0
    ? string.Join(" ", msgs)
    : null;
  }

  /// <summary>
  /// Clear both general and field errors before a new request.
  /// </summary>
  private void ClearErrors()
  {
    Error = null;
    FieldErrors.Clear();
  }

  private async Task OnLogin()
  {
    ClearErrors();
    Busy = true;

    try
    {
      // Keep request contract stable: API expects LoginRequest.Email + Password.
      var req = new LoginRequest { Email = Username, Password = Password };

      var auth = await Api.LoginAsync(req);

      await AppState.SetAuthAsync(
      auth.AccessToken,
      userId: auth.UserId.ToString(),
      isOnboarded: auth.IsOnboarded
      );

      Nav.NavigateTo(auth.IsOnboarded ? "/home" : "/onboarding", replace: true);
    }

    catch (ApiException ex)
    {
      // Field-level errors (e.g., Email/Password required) come here.
      Error = ex.Detail ?? ex.Title ?? ex.Message;
      FieldErrors = new Dictionary<string, string[]>(ex.Errors, StringComparer.OrdinalIgnoreCase);
    }
    catch (Exception ex)
    {
      // Fallback: unexpected errors.
      Error = ex.Message;
    }
    finally
    {
      Busy = false;
    }
  }

  private void GoRegister() => Nav.NavigateTo("/register");
}
