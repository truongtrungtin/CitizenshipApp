@page "/onboarding"

@inject ApiClient Api
@inject AppState State
@inject NavigationManager Nav

<h1>Onboarding</h1>

<p>Complete onboarding to unlock the app.</p>

@if (!State.IsAuthenticated)
{
  <div class="alert alert-warning">
    You must login first.
  </div>
  <button class="btn btn-primary" @onclick="GoLogin">Go to login</button>
}
else
{
  <button class="btn btn-success" @onclick="Complete" disabled="@Busy">Complete onboarding</button>

  @if (!string.IsNullOrWhiteSpace(Message))
  {
    <div class="alert alert-info mt-3">@Message</div>
  }
}

@code {
  private bool Busy { get; set; }
  private string? Message { get; set; }

  private async Task Complete()
  {
    Busy = true;
    Message = null;

    try
    {
      await Api.CompleteOnboardingAsync();
      await State.SetOnboardedAsync(true);

      Message = "Done! Redirecting...";
      Nav.NavigateTo("/", replace: true);
    }
    catch (Exception ex)
    {
      Message = $"Error: {ex.Message}";
    }
    finally
    {
      Busy = false;
    }
  }

  private void GoLogin()
  {
    Nav.NavigateTo("/login");
  }

}
