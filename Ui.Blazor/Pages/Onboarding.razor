@page "/onboarding"
<h1 data-testid="onboarding-title">@T["Onboarding.Title"]</h1>

@if (!string.IsNullOrWhiteSpace(_error))
{
  <div class="alert alert-danger mt-3">@_error</div>
}

@if (_loading)
{
  <div class="alert alert-info mt-3">@T["Onboarding.Loading"]</div>
}
else
{
  <div class="mt-3">

    <div class="mb-3">
      <label class="form-label fw-semibold">@T["Settings.Language"]</label>
      <div class="btn-group" role="group">
        <button class="btn @(_settings.Language == LanguageCode.Vi ? "btn-primary" : "btn-outline-primary")"
          @onclick="() => _settings = _settings with { Language = LanguageCode.Vi }" disabled="@_saving">
          Vietnamese
        </button>
        <button class="btn @(_settings.Language == LanguageCode.En ? "btn-primary" : "btn-outline-primary")"
          @onclick="() => _settings = _settings with { Language = LanguageCode.En }" disabled="@_saving">
          English
        </button>
      </div>
      @if (GetFieldError("Language") is { } e1)
      {
        <div class="text-danger small mt-1">@e1</div>
      }
    </div>

    <div class="mb-3">
      <label class="form-label fw-semibold">@T["Onboarding.Font"]</label>
      <div class="btn-group" role="group">
        <button class="btn @(_settings.FontScale == FontScale.Medium ? "btn-primary" : "btn-outline-primary")"
          @onclick="() => SetFontScaleAsync(FontScale.Medium)" disabled="@_saving">@T["Font.Small"]</button>

        <button class="btn @(_settings.FontScale == FontScale.Large ? "btn-primary" : "btn-outline-primary")"
          @onclick="() => SetFontScaleAsync(FontScale.Large)" disabled="@_saving">@T["Font.Medium"]</button>

        <button class="btn @(_settings.FontScale == FontScale.XLarge ? "btn-primary" : "btn-outline-primary")"
          @onclick="() => SetFontScaleAsync(FontScale.XLarge)" disabled="@_saving">@T["Font.Large"]</button>
      </div>
      @if (GetFieldError("FontScale") is { } e2)
      {
        <div class="text-danger small mt-1">@e2</div>
      }
    </div>

    <div class="mb-3">
      <label class="form-label fw-semibold">@T["Onboarding.Audio"]</label>
      <div class="btn-group" role="group">
        <button class="btn @(_settings.AudioSpeed == AudioSpeed.Slow ? "btn-primary" : "btn-outline-primary")"
          @onclick="() => _settings = _settings with { AudioSpeed = AudioSpeed.Slow }" disabled="@_saving">@T["Audio.Slow"]</button>

        <button class="btn @(_settings.AudioSpeed == AudioSpeed.Normal ? "btn-primary" : "btn-outline-primary")"
          @onclick="() => _settings = _settings with { AudioSpeed = AudioSpeed.Normal }"
          disabled="@_saving">@T["Audio.Medium"]</button>

        <button class="btn @(_settings.AudioSpeed == AudioSpeed.Fast ? "btn-primary" : "btn-outline-primary")"
          @onclick="() => _settings = _settings with { AudioSpeed = AudioSpeed.Fast }"
          disabled="@_saving">@T["Audio.Fast"]</button>
      </div>
      @if (GetFieldError("AudioSpeed") is { } e3)
      {
        <div class="text-danger small mt-1">@e3</div>
      }
    </div>

    <div class="mb-3">
      <label class="form-label fw-semibold">@T["Onboarding.DailyGoal"]</label>
      <div class="btn-group" role="group">
        <button class="btn @(_settings.DailyGoalMinutes == 15 ? "btn-primary" : "btn-outline-primary")"
          @onclick="() => _settings = _settings with { DailyGoalMinutes = 15 }" disabled="@_saving">15 min</button>

        <button class="btn @(_settings.DailyGoalMinutes == 30 ? "btn-primary" : "btn-outline-primary")"
          @onclick="() => _settings = _settings with { DailyGoalMinutes = 30 }" disabled="@_saving">30 min</button>

        <button class="btn @(_settings.DailyGoalMinutes == 45 ? "btn-primary" : "btn-outline-primary")"
          @onclick="() => _settings = _settings with { DailyGoalMinutes = 45 }" disabled="@_saving">45 min</button>
      </div>
      @if (GetFieldError("DailyGoalMinutes") is { } e4)
      {
        <div class="text-danger small mt-1">@e4</div>
      }
    </div>

    <div class="mb-3">
      <label class="form-label fw-semibold">@T["Onboarding.Focus"]</label>
      <div class="btn-group" role="group">
        <button class="btn @(_settings.Focus == StudyFocus.Civics ? "btn-primary" : "btn-outline-primary")"
          @onclick="() => _settings = _settings with { Focus = StudyFocus.Civics }" disabled="@_saving">@T["Focus.Civics"]</button>

        <button class="btn @(_settings.Focus == StudyFocus.Reading ? "btn-primary" : "btn-outline-primary")"
          @onclick="() => _settings = _settings with { Focus = StudyFocus.Reading }" disabled="@_saving">@T["Focus.Reading"]</button>

        <button class="btn @(_settings.Focus == StudyFocus.Writing ? "btn-primary" : "btn-outline-primary")"
          @onclick="() => _settings = _settings with { Focus = StudyFocus.Writing }" disabled="@_saving">@T["Focus.Writing"]</button>
      </div>
      @if (GetFieldError("Focus") is { } e5)
      {
        <div class="text-danger small mt-1">@e5</div>
      }
    </div>

    <div class="form-check mb-4">
      <input class="form-check-input" type="checkbox" id="silent" checked="@_settings.SilentMode"
        @onchange="OnSilentChanged" disabled="@_saving" />
      <label class="form-check-label" for="silent">@T["Onboarding.Silent"]</label>
      @if (GetFieldError("SilentMode") is { } e6)
      {
        <div class="text-danger small mt-1">@e6</div>
      }
    </div>

    <button class="btn btn-primary" data-testid="onboarding-start" @onclick="SaveAndContinueAsync" disabled="@_saving">
      @T["Onboarding.Start"]
    </button>
  </div>
}

@code {
  private bool _loading = true;
  private bool _saving;

  private string? _error;
  private Dictionary<string, string[]> _fieldErrors = new(StringComparer.OrdinalIgnoreCase);

  private UserSettingContracts _settings = new(
  LanguageCode.En,
  LanguageCode.Vi,
  FontScale.Medium,
  AudioSpeed.Normal,
  string.Empty,
  15,
  StudyFocus.Civics,
  false
  );

  protected override async Task OnInitializedAsync()
  {
    // Must be authenticated to do onboarding
    if (!AppState.IsAuthenticated)
    {
      Nav.NavigateTo("/login", replace: true);
      return;
    }

    try
    {
      ClearErrors();

      _settings = await Api.GetMeSettingsFullAsync();
      await UserSettings.ApplyAsync(_settings);
    }
    catch (ApiException ex)
    {
      _error = ex.Detail ?? ex.Title ?? ex.Message;
      _fieldErrors = new Dictionary<string, string[]>(ex.Errors, StringComparer.OrdinalIgnoreCase);
    }
    catch (Exception ex)
    {
      _error = ex.Message;
    }
    finally
    {
      _loading = false;
    }
  }

  private async Task SetFontScaleAsync(FontScale scale)
  {
    _settings = _settings with { FontScale = scale };

    // Preview immediately (no save needed)
    await UserSettings.ApplyAsync(_settings);
  }

  private void OnSilentChanged(ChangeEventArgs e)
  {
    // Blazor checkbox value is usually bool, but can be string in some cases.
    bool value =
    e.Value is bool b ? b
    : bool.TryParse(e.Value?.ToString(), out var parsed) && parsed;

    _settings = _settings with { SilentMode = value };
  }

  private string? GetFieldError(string field)
  {
    return _fieldErrors.TryGetValue(field, out var msgs) && msgs.Length > 0
    ? string.Join(" ", msgs)
    : null;
  }

  private void ClearErrors()
  {
    _error = null;
    _fieldErrors.Clear();
  }

  private async Task SaveAndContinueAsync()
  {
    ClearErrors();
    _saving = true;

    try
    {
      // 1) Save full settings
      await Api.UpdateMeSettingsFullAsync(_settings);

      await UserSettings.ApplyAsync(_settings);

      // 2) Mark onboarding complete on server
      await Api.CompleteOnboardingAsync();

      // 3) Update local state so RouteGuard stops forcing /onboarding
      await AppState.SetOnboardedAsync(true);

      // 4) Go home
      Nav.NavigateTo("/home", replace: true);
    }
    catch (ApiException ex)
    {
      _error = ex.Detail ?? ex.Title ?? ex.Message;
      _fieldErrors = new Dictionary<string, string[]>(ex.Errors, StringComparer.OrdinalIgnoreCase);
    }
    catch (Exception ex)
    {
      _error = ex.Message;
    }
    finally
    {
      _saving = false;
    }
  }
}
