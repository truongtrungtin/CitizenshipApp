name: ci

on:
  push:
    branches: ["main"]
  pull_request:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build_test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Repo hygiene checks
        shell: bash
        run: |
          set -euo pipefail

          tracked_artifacts=$(git ls-files | grep -E '(^|/)(bin|obj)/' || true)
          if [ -n "$tracked_artifacts" ]; then
            echo "ERROR: Tracked build artifacts detected (bin/ or obj/)."
            echo "Remove them from git index (keep on disk) and rely on .gitignore. Sample:"
            echo "$tracked_artifacts" | head -n 50
            exit 1
          fi

          tracked_env=$(git ls-files | grep -E '(^|/)\.env(\.|$)' || true)
          tracked_env_non_example=$(echo "$tracked_env" | grep -v -E '^\.env\.example$' || true)
          if [ -n "$tracked_env_non_example" ]; then
            echo "ERROR: Tracked .env files detected (potential secrets)."
            echo "Keep only .env.example committed. Found:"
            echo "$tracked_env_non_example" | head -n 50
            exit 1
          fi

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"
          # NuGet caching in setup-dotnet requires packages.lock.json.
          # This repo doesn't use lock files, so keep caching disabled.
          cache: false

      - name: Format (verify no changes)
        shell: bash
        run: dotnet format CitizenshipApp.sln --verify-no-changes --severity warn

      - name: Restore
        run: dotnet restore CitizenshipApp.sln

      - name: Build
        run: dotnet build CitizenshipApp.sln -c Release --no-restore

      - name: Test
        run: dotnet test CitizenshipApp.sln -c Release --no-build
